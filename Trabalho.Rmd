---
title: "Impact of Air Pollution on Chronic Respiratoy Diseases: An Exploratory Data Analysis of GBD Data"
author: "João Silva, Marco Pereira, Mariana Ribeiro"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
    citation_package: default
bibliography: referencias.bib
csl: apa7.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message=FALSE, warning=FALSE, cache=TRUE)
```

# Abstract

Este trabalho analisa os impactos da poluição do ar na saúde pública utilizando 
dados do Global Burden of Disease (GBD)[@bennitt_global_nodate]. Através de técnicas de preparação e 
análise exploratória de dados (EDA), são identificadas tendências, padrões e 
potenciais problemas de qualidade nos dados.

# Introduction

A poluição do ar é um dos principais fatores de risco para doenças respiratórias 
e cardiovasculares. Este estudo visa explorar os dados do GBD para compreender 
melhor os efeitos da poluição do ar em diferentes países, faixas etárias e géneros.

# Methodology

## Data source

- Dados extraídos do GBD 2021
- Ferramenta utilizada: GBD Results Tool
- Link da pesquisa e ficheiro:
1990 + Global + SDI + Health System
https://vizhub.healthdata.org/gbd-results?params=gbd-api-2021-permalink/4ea5715918446e5a6d9b154d62e0cc4a
IHME-GBD_2021_DATA-4835a3dc-1.csv
2000 + Global + SDI + Health System
https://vizhub.healthdata.org/gbd-results?params=gbd-api-2021-permalink/64781d061f111ef4af5ad17974b6eb98
IHME-GBD_2021_DATA-c56a3848-1.csv
2010 + Global + SDI + Health System
https://vizhub.healthdata.org/gbd-results?params=gbd-api-2021-permalink/88ae5e347d197231fa598e3dfc8e219a
IHME-GBD_2021_DATA-1923af35-1.csv
2020 + Global + SDI + Health System
https://vizhub.healthdata.org/gbd-results?params=gbd-api-2021-permalink/2d070aac165f1d6a455d41df6c34e501
IHME-GBD_2021_DATA-d14075a8-1.csv
2021 + Global + SDI + Health System
https://vizhub.healthdata.org/gbd-results?params=gbd-api-2021-permalink/3fad5e919cb9822381a5b56543978c2a
IHME-GBD_2021_DATA-840155c6-1.csv
1990 + Países todos + Age (all + standardized) + Sex (Both)
https://vizhub.healthdata.org/gbd-results?params=gbd-api-2021-permalink/8dcef8a43426d16927c72f4d2a96147c
IHME-GBD_2021_DATA-7baf5a43-1.csv
2000 + Países todos + Age (all + standardized) + Sex (Both)
https://vizhub.healthdata.org/gbd-results?params=gbd-api-2021-permalink/137d422bc7e27adb3442cd2a0c699368
IHME-GBD_2021_DATA-db69c1e8-1.csv
2010 + Países todos + Age (all + standardized) + Sex (Both)
https://vizhub.healthdata.org/gbd-results?params=gbd-api-2021-permalink/be61825c6c4ec111b07e9d9847613cd0
IHME-GBD_2021_DATA-dcf93c30-1.csv
2020 + Países todos + Age (all + standardized) + Sex (Both)
https://vizhub.healthdata.org/gbd-results?params=gbd-api-2021-permalink/972411dc3a931543fdecc15424db9019
IHME-GBD_2021_DATA-03b79351-1.csv
2021 + Países todos + Age (all + standardized) + Sex (Both)
https://vizhub.healthdata.org/gbd-results?params=gbd-api-2021-permalink/337e92e538d09c5d3d80640ee324032e
IHME-GBD_2021_DATA-ce582a59-1.csv
Todos os anos + Países GBD exceto costum + Age standardized + Sex (Both)
https://vizhub.healthdata.org/gbd-results?params=gbd-api-2021-permalink/0afce2e9094f891f22453111c6986ffb
IHME-GBD_2021_DATA-382c4db5-1.csv

- Em termos de temas (features) temos:
        *Fatores de risco (poluição e subdivisões e tabagismo)
        *Causa (doenças respiratórias crónicas e suas subdivisões)
        *Sexo
        *Idade
        *Locais (regiões who, continentes (?), SDI e sistemas de saúde)
        *Anos (1990, 2000, 2010,2020 e 2021)

## Data preparation

- Seleção de colunas relevantes (e.g., país, ano, sexo, idade, medida, causa)
- Tratamento de dados faltantes e outliers
- Verificação de formatos e consistência

```{r}
#install.packages(c("tidyverse", "scales", "rnaturalearth", "rnaturalearthdata", "sf", "countrycode", "viridis","patchwork"))

# Load necessary libraries
library(tidyverse) #Já inclui dplyr + ggplot2 + forcat etc...
library(scales)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(countrycode)
library(viridis)
library(patchwork)
library(purrr)
#Remove everything, clean environment
rm(list = ls())
```

```{r}
#Importar os dados
gbd_data <- read.csv("IHME-GBD_2021_DATA-4835a3dc-1.csv")
gbd_data2 <- read.csv("IHME-GBD_2021_DATA-c56a3848-1.csv")
gbd_data3 <- read.csv("IHME-GBD_2021_DATA-1923af35-1.csv")
gbd_data4 <- read.csv("IHME-GBD_2021_DATA-d14075a8-1.csv")
gbd_data5 <- read.csv("IHME-GBD_2021_DATA-840155c6-1.csv")
gbd_data6 <- read.csv("IHME-GBD_2021_DATA-7baf5a43-1.csv")
gbd_data7 <- read.csv("IHME-GBD_2021_DATA-db69c1e8-1.csv")
gbd_data8 <- read.csv("IHME-GBD_2021_DATA-dcf93c30-1.csv")
gbd_data9 <- read.csv("IHME-GBD_2021_DATA-03b79351-1.csv")
gbd_data10 <- read.csv("IHME-GBD_2021_DATA-ce582a59-1.csv")
gbd_data11 <- read.csv("IHME-GBD_2021_DATA-382c4db5-1.csv")
#Juntar as bases de dados
gbd_total <- bind_rows(gbd_data, gbd_data2,gbd_data3,gbd_data4,gbd_data5,gbd_data6,
        gbd_data7,gbd_data8,gbd_data9,gbd_data10,gbd_data11)
```

```{r}
#Sumário dos dados
glimpse(gbd_total)
```
```{r}
#library(dlookr)
#gbd_total %>%
  #diagnose_paged_report(output_format = "html", output_file = "Diagn.html")
#Paged dá para escolher pdf se for web não dá
```


```{r}
# Converter colunas para factor
gbd_total <- gbd_total %>%
        mutate(across(c(measure, location, sex, age, cause, rei, metric), as.factor))
```

```{r}
names(gbd_total)
```

```{r,results='asis'}
# Devolve um vetor com todos os valores únicos (os nomes das categorias)
measure_classes <- unique(gbd_total$measure)
location_classes <- unique(gbd_total$location)
sex_classes <- unique(gbd_total$sex)
age_classes <- unique(gbd_total$age)
cause_classes <- unique(gbd_total$cause)
rei_classes <- unique(gbd_total$rei)
metric_classes <- unique(gbd_total$metric)
year_classes <- unique(gbd_total$year)
# Criar uma lista com todas as variáveis
classes_list <- list(
        measure = measure_classes,
        location = location_classes,
        sex = sex_classes,
        age = age_classes,
        cause = cause_classes,
        rei = rei_classes,
        metric = metric_classes,
        year = year_classes
)
# Função para formatar cada categoria
format_line <- function(name, values) {
  paste0("**", name, ":** ", paste(values, collapse = ", "), "  \n")
}

# Aplicar a função à lista
markdown_text <- purrr::map2(names(classes_list), classes_list, format_line) %>%
  paste(collapse = "")

# Imprimir no formato Markdown
cat(markdown_text)
```

## Tools

- Linguagem: R
- Ambiente: RStudio
- Pacotes: `tidyverse`

# Results

```{r}
# Custom palette: worse -> better
pal <- c(
        "High SDI" = "#1a9850",
        "High-middle SDI" = "#fee08b",
        "Middle SDI" = "#fed976",
        "Low-middle SDI" = "#fdae61",
        "Low SDI" = "#b2182b",
        "Minimal Health System"   = "#b2182b",
        "Limited Health System"   = "#fdae61",
        "Basic Health System"     = "#fee08b",
        "Advanced Health System"  = "#1a9850"
        )
# Define the health system categories
SDI_regions <- c(
        "Low SDI",
        "Low-middle SDI",
        "Middle SDI",
        "High-middle SDI",
        "High SDI"
        )
# Define the health system categories
health_systems <- c("Advanced Health System",
                    "Basic Health System",
                    "Limited Health System",
                    "Minimal Health System")
# Define countries
countries <- gbd_data10$location
# Define country super regions
country_regions <- gbd_data11$location
```

## Impact of different types of polluents

```{r}
df_types <- gbd_total %>%
        filter(
                measure =="DALYs (Disability-Adjusted Life Years)",
                cause == "Chronic respiratory diseases",
                rei %in% c("Ambient particulate matter pollution", 
                           "Household air pollution from solid fuels",
                           "Nitrogen dioxide pollution",
                           "Ambient ozone pollution"),
                metric == "Rate",     
                location == "Global",
                age == "All ages",
                sex == "Both"
        )
# Ordenar tipos de poluição para apresentação consistente
df_types$rei <- factor(df_types$rei,
        levels = c("Household air pollution from solid fuels",
                "Ambient particulate matter pollution",
                "Nitrogen dioxide pollution",
                "Ambient ozone pollution"
        ))
# Nova paleta para tipos de poluição
pal_pollution <- c(
        "Ambient particulate matter pollution" = "#fdae61",
        "Household air pollution from solid fuels" =  "#b2182b" ,
        "Nitrogen dioxide pollution" = "#2b83ba",
        "Ambient ozone pollution" = "#66c2a5"
        )
# Plot
df_types %>% 
        ggplot(aes(x = rei, y = val, fill = rei)) +
        geom_col(color = "black", width = 0.7) +
        geom_errorbar(
                aes(ymin = lower, ymax = upper), 
                width = 0.18, 
                size = 0.6, 
                color = "black"
        ) +
        geom_text(
                aes(label = round(val, 0)), 
                hjust = -1, 
                vjust = -0.9,
                size = 4) +
        scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
        scale_fill_manual(values = pal_pollution, name = "Type of pollution") +
        facet_grid(measure ~ cause, scales = "free_y") +
        coord_flip() +
        labs(
                title = "Global Impact of Different Types of Air Pollution on CRD (2021)",
                subtitle = "DALYs per 100,000 population",
                x = "",
                y = "Rate per 100,000",
                caption = "Data source: GBD 2021"
        ) +
        theme_minimal(base_size = 13) +
        theme(
                legend.position = "none",
                strip.text = element_text(face = "bold", size = 20),
                plot.title = element_text(face = "bold", size = 24),
                plot.subtitle = element_text(size = 16),
                axis.title.x = element_text(size = 20, face = "bold"),  # y-axis title (since coord_flip)
                axis.title.y = element_text(size = 18, face = "bold"),  # x-axis title
                axis.text.x  = element_text(size = 14),                 # tick labels (x-axis)
                axis.text.y  = element_text(size = 18)                  # tick labels (y-axis)
        )
```


## Impact on different Socio-demographic Index

### Percentage of Household Air Pollution contribution on particulate matter pollution

```{r}
# Filter and summarise for Rate:
df_SDI2 <- gbd_total %>%
        filter(
                location %in% SDI_regions,
                rei %in% c("Household air pollution from solid fuels",
                        "Ambient particulate matter pollution"),
                metric == "Rate",     
                cause == "Chronic respiratory diseases",
                age == "Age-standardized",
                sex == "Both"
        ) %>%
        select(measure, location, val, rei)
# Calcular proporção de Household / (Ambient + Household)
df_prop <- df_SDI2 %>%
        filter(rei %in% c("Ambient particulate matter pollution",
                "Household air pollution from solid fuels")) %>%
        group_by(location, measure) %>%
        summarise(
                ambient = sum(val[rei == "Ambient particulate matter pollution"], na.rm = TRUE),
                household = sum(val[rei == "Household air pollution from solid fuels"], na.rm = TRUE)
        ) %>%
        mutate(proportion_household = household / (ambient + household))
# Make sure your health_systems are ordered in the plot
df_prop <- df_prop %>%
        mutate(location = factor(location, levels = c(
                "Low SDI",
                "Low-middle SDI",
                "Middle SDI",
                "High-middle SDI",
                "High SDI"
        )))
# Ordered measure
df_prop$measure <- factor(df_prop$measure,
        levels = c(
                "Deaths",
                "DALYs (Disability-Adjusted Life Years)",
                "YLLs (Years of Life Lost)",
                "YLDs (Years Lived with Disability)"
        ))
# Plot
df_prop %>% 
        ggplot(aes(x = location, y = proportion_household, fill = location)) +
        geom_col(color = "black", width = 0.7) +
        geom_text(
                aes(label = scales::percent(proportion_household, accuracy = 1)),
                hjust = -0.2, 
                size = 4
        ) +
        scale_fill_manual(values = pal) +
        scale_y_continuous(
                labels = percent_format(accuracy = 1), 
                limits = c(0, 1.05)
        ) +
        facet_wrap(~ measure, scales = "free_x") +
        coord_flip() +
        labs(
                title = "Percentage of Household Air Pollution contribution on particulate matter pollution",
                subtitle = "By SDI classes (2021)",
                x = "",
                y = "",
                caption = "Source: GBD 2021"
        ) +
        theme_minimal(base_size = 13) +
        theme(
                legend.position = "none",
                strip.text = element_text(face = "bold", size = 20),
                plot.title = element_text(face = "bold", size = 24),
                plot.subtitle = element_text(size = 16),
                axis.title.x = element_text(size = 18, face = "bold"),  # y-axis title (since coord_flip)
                axis.title.y = element_text(size = 18, face = "bold"),  # x-axis title
                axis.text.x  = element_text(size = 14),                 # tick labels (x-axis)
                axis.text.y  = element_text(size = 14)                  # tick labels (y-axis)
        )
```


### Impact of Particulate Matter Pollution by SDI Classes (2021)

```{r}
# Filter and summarise for Rate:
df_SDI_regions <- gbd_total %>%
        filter(
                location %in% SDI_regions,
                rei == "Air pollution",
                metric == "Rate",       # <- ensure we are using Rate, not Number
                cause == "Chronic respiratory diseases",
                age == "Age-standardized",
                sex == "Both"
        ) %>%
        select(measure, location, val, upper, lower)
# Make sure SDI regions are ordered in the plot
df_SDI_regions <- df_SDI_regions %>%
        mutate(location = factor(location, levels = c(
                "Low SDI",
                "Low-middle SDI",
                "Middle SDI",
                "High-middle SDI",
                "High SDI"
        )))
# Ordered measure
df_SDI_regions$measure <- factor(df_SDI_regions$measure,levels = c(
        "Deaths",
        "DALYs (Disability-Adjusted Life Years)",
        "YLLs (Years of Life Lost)",
        "YLDs (Years Lived with Disability)"
        ))
# Plot
df_SDI_regions %>% 
        ggplot(aes(x = location, y = val, fill = location)) +
        geom_col(color = "black", width = 0.7) +
        geom_errorbar(
                aes(ymin = lower, ymax = upper), 
                width = 0.18, 
                size = 0.6, 
                color = "black") +
        geom_text(
                aes(label = round(val, 0)), 
                hjust = -0.1, 
                vjust = -0.4,
                size = 4
        ) +
        scale_fill_manual(values = pal) +
        scale_y_continuous() +
        facet_wrap(~ measure, scales = "free_x") +
        coord_flip() +
        labs(
                title = "Impact of Particulate Matter Pollution by SDI Classes (2021)",
                subtitle = "Deaths, DALYs, YLLs & YLDS (per 100,000 population) with 95% uncertainty intervals",
                x = "",
                y = "Rate per 100,000",
                caption = "Data Source: GBD 2021"
        ) +
        theme_minimal(base_size = 13) +
        theme(
                legend.position = "none",
                strip.text = element_text(face = "bold", size = 20),
                plot.title = element_text(face = "bold", size = 24),
                plot.subtitle = element_text(size = 16),
                axis.title.x = element_text(size = 18, face = "bold"),  # y-axis title (since coord_flip)
                axis.title.y = element_text(size = 18, face = "bold"),  # x-axis title
                axis.text.x  = element_text(size = 14),                 # tick labels (x-axis)
                axis.text.y  = element_text(size = 14)                  # tick labels (y-axis)
        )
```

## DALYs attributable to household vs ambient particulate air pollution worldwide (1990–2021)


```{r}
# Preparar os dados
global_DALYS_year <- gbd_total %>%
        filter(
                measure == "DALYs (Disability-Adjusted Life Years)",
                location == "Global",
                rei %in% c("Household air pollution from solid fuels","Ambient particulate matter pollution"),
                metric == "Number",
                cause == "Chronic respiratory diseases",
                age == "All ages",
                sex == "Both"
        ) %>%
        select(rei, year, val, upper, lower)
# Plot
global_DALYS_year %>%
        ggplot(aes(x = year, y = val, color = rei, fill = rei, group = rei)) +
        geom_ribbon(
                aes(ymin = lower, ymax = upper), 
                alpha = 0.2, 
                color = NA) +
        geom_line(size = 1.2) +
        scale_color_manual(values = c(
                "Ambient particulate matter pollution" = "#fdae61",
                "Household air pollution from solid fuels" = "#b2182b"
        )) +
        scale_fill_manual(values = c(
                "Ambient particulate matter pollution" = "#fdae61",
                "Household air pollution from solid fuels" = "#b2182b"
        )) +
        geom_point(size = 2) +
        labs(
                title = "DALYs attributable to particulate air pollution worldwide (1990–2021)",
                x = "Year",
                y = "DALYs (Number)",
                color = NULL,
                fill = NULL,
                caption = "Data Source: Global Burden of Disease 2021"
        ) +
        theme_minimal() +
        theme(
                axis.title.x = element_text(size = 18),
                axis.title.y = element_text(size = 18),
                plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
                plot.subtitle = element_text(size = 14, hjust = 0.5),
                legend.title = element_text(size = 18),
                legend.text = element_text(size = 18)
        )
```

## Geographical Distribution


### Global health impact of air pollution on CRD in 1990 and 2021


```{r}
#Filter and select relevant columns for deaths in 2021
df_deaths_clean_2021 <- gbd_total %>%
        filter(
                measure == "Deaths",
                location %in% countries,
                sex == "Both",
                age == "Age-standardized",
                cause == "Chronic respiratory diseases",
                rei == "Air pollution",
                metric == "Rate",
                year == "2021"
        ) %>%
        select(location, val, upper, lower)

#Filter and select relevant columns for deaths in 1990
df_deaths_clean_1990 <- gbd_total %>%
        filter(
                measure == "Deaths",
                location %in% countries,
                sex == "Both",
                age == "Age-standardized",
                cause == "Chronic respiratory diseases",
                rei == "Air pollution",
                metric == "Rate",
                year == "1990"
        ) %>%
        select(location, val, upper, lower)

# Load world map
world <- ne_countries(scale = "medium", returnclass = "sf")

# Standardize country names using countrycode

## First, create ISO3 codes for GBD data
df_deaths_clean_2021$iso3 <- countrycode(df_deaths_clean_2021$location,
                                        origin = "country.name",
                                        destination = "iso3c")

df_deaths_clean_1990$iso3 <- countrycode(df_deaths_clean_1990$location,
                                         origin = "country.name",
                                         destination = "iso3c")
## Create ISO3 codes for world map
world$iso3 <- countrycode(world$name,
                          origin = "country.name",
                          destination = "iso3c")

## Check unmatched countries
unmatched <- df_deaths_clean_2021 %>%
        filter(!iso3 %in% world$iso3) %>% # Keep all countries whose ISO3 code is not in the world dataset.
        select(location, iso3)
#unmatched$location
### The non correlation with the iso3 code is from the world dataset (bc df does not have Null values associated)

## Fix known mismatches manually
world$name[world$name == "Micronesia"] <- "Micronesia (Federated States of)"
world$name[world$name == "St. Vin. and Gren."] <- "Saint Vincent and the Grenadines"
world$name[world$name == "U.S. Virgin Is."] <- "United States Virgin Islands "
world$name[world$name == "S. Sudan"] <- "South Sudan "
### Tokelau cannot be matched

## Recalculate ISO3 codes after fixing names
world$iso3 <- countrycode(world$name,
                          origin = "country.name",
                          destination = "iso3c")

## Check unmatched countries AGAIN
unmatched <- df_deaths_clean_2021 %>%
        filter(!iso3 %in% world$iso3) %>%
        select(location)
#unmatched$location

# Merge GBD data with world map
world_data_2021 <- world %>%
        left_join(df_deaths_clean_2021, by = "iso3")
world_data_1990 <- world %>%
        left_join(df_deaths_clean_1990, by = "iso3")

# Determine the common range across both datasets
fill_limits <- range(c(world_data_1990$val, world_data_2021$val), na.rm = TRUE)

# Plot DEATHS 2021
p2021 <- ggplot(data = world_data_2021) +
        geom_sf(aes(fill = val), color = "grey40", size = 0.1) +
        scale_fill_viridis_c(
                option = "inferno", 
                na.value = "lightgrey", 
                direction = -1,
                name = "Deaths/100k", 
                limits = fill_limits
        ) +
        labs(
                title = "Global health impact of air pollution on CRD in 2021",
                subtitle = "Death rates per 100,000 population",
                caption = "Data Source: GBD 2021"
        ) +
        theme_minimal() +
        theme(
                plot.title = element_text(size = 20, face = "bold"),
                plot.subtitle = element_text(size = 14),
                legend.title = element_text(size = 12),
                legend.text = element_text(size = 10)
        )

# Plot DEATHS 1990
p1990 <- ggplot(data = world_data_1990) +
        geom_sf(aes(fill = val), color = "grey40", size = 0.1) +
        scale_fill_viridis_c(
                option = "inferno", 
                na.value = "lightgrey", 
                direction = -1,
                name = "Deaths/100k", 
                limits = fill_limits
        ) +
        labs(
                title = "Global health impact of air pollution on CRD in 1990",
                subtitle = "Death rates per 100,000 population",
                caption = "Data Source: GBD 2021"
        ) +
        theme_minimal() +
        theme(
                plot.title = element_text(size = 20, face = "bold"),
                plot.subtitle = element_text(size = 14),
                legend.title = element_text(size = 12),
                legend.text = element_text(size = 10)
        )

# Common theme to make things consistent
base_theme <- theme_minimal() +
        theme(
                plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
                legend.title = element_text(size = 12),
                legend.text = element_text(size = 10),
                axis.text = element_blank(),
                axis.title = element_blank(),
                panel.grid = element_blank()
        )

# --- Plot for 1990 (no legend, simple title) ---
p1990 <- ggplot(data = world_data_1990) +
        geom_sf(
                aes(fill = val), 
                color = "grey40", 
                size = 0.1
        ) +
        scale_fill_viridis_c(
                option = "inferno", 
                na.value = "lightgrey",
                direction = -1, 
                name = "Deaths/100k", 
                limits = fill_limits
        ) +
        labs(title = "1990") +
        base_theme +
        theme(legend.position = "none")  # remove legend

# --- Plot for 2021 (keep legend) ---
p2021 <- ggplot(data = world_data_2021) +
        geom_sf(
                aes(fill = val), 
                color = "grey40", 
                size = 0.1
        ) +
        scale_fill_viridis_c(
                option = "inferno", 
                na.value = "lightgrey",
                direction = -1, 
                name = "Deaths/100k", 
                limits = fill_limits
        ) +
  labs(title = "2021") +
  base_theme

# --- Combine side by side ---
combined <- p1990 + p2021 +
        plot_annotation(
                title = "Global health impact of air pollution on CRD",
                subtitle = "Death rates per 100,000 population",
                caption = "Data Source: GBD 2021"
        ) &
        theme(
                plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
                plot.subtitle = element_text(size = 14, hjust = 0.5)
        )
print(combined)
```

### Country ranking by all measures in 2021


```{r,warning=FALSE}
# Filtrar linhas
gbd_filtered <- gbd_total %>% 
        filter(
                location %in% gbd_data11$location,
                sex == "Both",
                age == "Age-standardized",
                cause == "Chronic respiratory diseases",
                rei == "Air pollution",
                metric == "Rate",
                year == "2021",
        )
# Obter os top 10 locais com mais mortes
top_locations <- gbd_filtered %>%
  filter(measure == "Deaths") %>%
  arrange(desc(val)) %>%
  mutate(rank = row_number()) %>%
  slice(1:10) %>%
  pull(location)
# Adicionar coluna de rank por medida e ordenar
gbd_filtered <- gbd_filtered %>%
        group_by(measure) %>%
        mutate(
                rank = rank(-val, ties.method = "first"),
                rank = if_else(rank <= 10, rank, NA_integer_),
                location = fct_reorder(location, desc(val))
        ) %>%
        ungroup()
# Fazer Barplot
gbd_filtered %>%
        ggplot(aes(x = location, y = val,color = measure, group = measure)) +
        geom_line(
                size = 1,
                alpha = 0.5,
        ) +
        geom_point(
                size = 3,
                alpha = 0.5,
        ) +
        geom_text(
                aes(x = location, y = val, label = rank), 
                vjust = -1.5, 
                size = 3, 
                fontface = "bold", 
                inherit.aes = FALSE) +
        labs(
                title = "Chronic Respiratory Disease Burden by Region (2021)",
                x = "Regions (ordered by decreasing number of deaths)",
                y = "Measure (rate)",
                color = "Measure",
                caption = "Data source: GBD 2021"
        ) +
        theme_minimal() +
        theme(
                axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        )
```

### Top 10 countries by air pollution death rates on CRD


#### Comparison between 1990 and 2021


```{r}
# Top 10 highest
top10_high_2021 <- df_deaths_clean_2021 %>%
        arrange(desc(val)) %>%
        slice_head(n = 10)
top10_high_1990 <- df_deaths_clean_1990 %>%
        arrange(desc(val)) %>%
        slice_head(n = 10)

# Top 10 lowest
top10_low_2021 <- df_deaths_clean_2021 %>%
        arrange(val) %>%
        slice_head(n = 10)
top10_low_1990 <- df_deaths_clean_1990 %>%
        arrange(val) %>%
        slice_head(n = 10)

# Combine both into one table
top10_high_table <- bind_rows(
        top10_high_2021 %>% mutate(year = "2021"),
        top10_high_1990 %>% mutate(year = "1990")
        ) %>%
        select(year, location, val, upper, lower)
top10_low_table <- bind_rows(
        top10_low_2021 %>% mutate(year = "2021"),
        top10_low_1990 %>% mutate(year = "1990")
        ) %>%
        select(year, location, val, upper, lower)

# Make sure year is a factor so colors are consistent
top10_high_table$year <- factor(top10_high_table$year, levels = c("1990", "2021"))
top10_low_table$year <- factor(top10_low_table$year, levels = c("1990", "2021"))

# Define a consistent color mapping for years
year_colors <- c("1990" = "#003f5c", "2021" = "#ffa600")

# --- Base theme ---
base_theme2 <- theme_minimal() +
        theme(
                plot.title = element_text(size = 14, face = "bold"),
                axis.title.y = element_blank(),
                axis.title.x = element_text(size = 12),
                axis.text = element_text(size = 10),
                legend.title = element_text(size = 12),
                legend.text = element_text(size = 10)
        )

# --- Lollipop HIGH ---
p_high <- top10_high_table %>% 
        ggplot(aes(x = reorder(location, val), y = val, color = year)) +
        geom_point(size = 4) +
        geom_segment(
                aes(x = location, xend = location, y = 0, yend = val), 
                linewidth = 1
        ) +
        geom_errorbar(
                aes(ymin = lower, ymax = upper), 
                width = 0.2
        ) +
        coord_flip() +
        scale_color_manual(values = year_colors, name = "Year") +
        labs(
                title = "Highest", 
                y = "Deaths/100k"
        ) +
        base_theme2 +
        theme(legend.position = "none")  # hide legend for this plot

# --- Lollipop LOW ---
p_low <- top10_low_table %>% 
        ggplot(aes(x = reorder(location, -val), y = val, color = year)) +
        geom_point(size = 4) +
        geom_segment(
                aes(x = location, xend = location, y = 0, yend = val), 
                linewidth = 1
        ) +
        geom_errorbar(
                aes(ymin = lower, ymax = upper), 
                width = 0.2) +
        coord_flip() +
        scale_color_manual(values = year_colors, name = "Year") +
        labs(
                title = "Lowest", 
                y = "Deaths/100k"
        ) +
        base_theme2  # keep legend here

# --- Combine side by side ---
combined <- p_high + p_low +
        plot_annotation(
                title = "Top 10 countries by air pollution death rates on CRD",
                subtitle = "Comparison between 1990 and 2021",
                caption = "Data Source: GBD 2021"
        ) &
        theme(
                plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
                plot.subtitle = element_text(size = 14, hjust = 0.5)
        )
combined
```

## Impact of Air Pollution on CRD by Health System Type (2021)


```{r}
# Filter and summarise for Rate:
df_healthsystems <- gbd_total %>%
        filter(
                location %in% health_systems,
                rei == "Air pollution",
                metric == "Rate",       # <- ensure we are using Rate, not Number
                cause == "Chronic respiratory diseases",
                age == "Age-standardized",
                sex == "Both"
        ) %>%
        select(measure, location, val, upper, lower)

# Make sure your health_systems are ordered in the plot
df_healthsystems <- df_healthsystems %>%
        mutate(location = factor(location, levels = c(
                "Minimal Health System",
                "Limited Health System",
                "Basic Health System",
                "Advanced Health System"
        )))

# Ordered measure
df_healthsystems$measure <- factor(df_healthsystems$measure,
                                     levels = c("Deaths",
                                        "DALYs (Disability-Adjusted Life Years)",
                                        "YLLs (Years of Life Lost)",
                                        "YLDs (Years Lived with Disability)")
                                )

# Plot
df_healthsystems %>% 
        ggplot(aes(x = location, y = val, fill = location)) +
        geom_col(color = "black", width = 0.7) +
        geom_errorbar(
                aes(ymin = lower, ymax = upper), 
                width = 0.18, 
                size = 0.6, 
                color = "black"
        ) +
        scale_fill_manual(values = pal) +
        scale_y_continuous() +
        facet_wrap(~ measure, scales = "free_x") +
        coord_flip() +
        labs(
                title = "Impact of Air Pollution on CRD by Health System Type (2021)",
                subtitle = "Deaths, DALYs, YLLs & YLDS (per 100,000 population) with 95% uncertainty intervals",
                x = "",
                y = "Rate per 100,000",
                caption = "Data Source: GBD 2021"
        ) +
        theme_minimal(base_size = 13) +
        theme(
                legend.position = "none",
                strip.text = element_text(face = "bold", size = 20),
                plot.title = element_text(face = "bold", size = 24),
                plot.subtitle = element_text(size = 16),
                axis.title.x = element_text(size = 18, face = "bold"),  # y-axis title (since coord_flip)
                axis.title.y = element_text(size = 18, face = "bold"),  # x-axis title
                axis.text.x  = element_text(size = 14),                 # tick labels (x-axis)
                axis.text.y  = element_text(size = 14)                  # tick labels (y-axis)
        )
```

## Temporal trends


```{r}
# Combine the four metrics into one dataset
global_summary_all <- gbd_total %>%
        filter(
                measure %in% c("Deaths",
                                "DALYs (Disability-Adjusted Life Years)",
                                "YLLs (Years of Life Lost)",
                                "YLDs (Years Lived with Disability)"),
                location == "Global",
                rei == "Air pollution",
                metric == "Rate",
                cause == "Chronic respiratory diseases",
                age == "All ages",
                sex == "Both"
        ) %>%
        select(measure, year, val, upper, lower)
# Ordered measure
global_summary_all$measure <- factor(global_summary_all$measure,
                                     levels = c("Deaths",
                                                "DALYs (Disability-Adjusted Life Years)",
                                                "YLLs (Years of Life Lost)",
                                                "YLDs (Years Lived with Disability)")
)
# Plot
global_summary_all %>% 
        ggplot(aes(x = year, y = val, color = measure, fill = measure)) +
        geom_ribbon(
                aes(ymin = lower, ymax = upper), 
                alpha = 0.2, 
                color = NA
        ) +
        geom_line(size = 1.2) +
        geom_point(size = 2) +
        facet_wrap(~ measure, scales = "free_y") +
        labs(
                title = "Global burden attributable to air pollution on CRD (1990–2021)",
                x = "Year",
                y = "Rate",
                color = "Measure",
                fill = "Measure",
                caption = "Data Source: GBD 2021"
        ) +
        scale_y_continuous(labels = scientific_format(digits = 2)) +
        theme_minimal(base_size = 13) +
        theme(
                axis.title.x = element_text(size = 14, face = "bold"),
                axis.title.y = element_text(size = 14, face = "bold"),
                axis.text.x  = element_text(size = 14),   # x-axis tick labels
                axis.text.y  = element_text(size = 14),   # y-axis tick labels
                plot.title   = element_text(size = 20, face = "bold"),
                strip.text   = element_text(size = 16, face = "bold"),
                legend.position = "none"
        )
```

## Age and Gender


```{r}
# Filtrar apenas linhas com metric == "Rate" e measure == "Deaths"
gbd_filtered <- gbd_total %>% 
        filter(
                measure == "Deaths" & 
                location == "Global" & 
                sex %in% c("Male", "Female") &
                !age %in% c("All ages", "7-27 days", "Age-standardized") &
                cause == "All causes" & 
                rei == "Air pollution" & 
                metric == "Rate" & 
                year == "2021"
        )
# Fazer Barplot
gbd_filtered %>%
        ggplot(aes(x = age, y = val, fill = sex)) +  # Adicionado fill = sex para agrupamento
        geom_bar(
                stat = "identity", 
                width = 0.6,
                alpha = 0.5,
        ) +  # position_dodge para barras lado a lado
        labs(
                title = "Impact of Type of Air Pollution by Age and Gender (2021)",
                x = "Age", 
                y = "Deaths (rate per 100,000)", 
                fill = "Gender",
                caption = "Data Source: GBD 2021"
        ) +
        theme_minimal() +
        theme(legend.position = "right")
```


# Discussão

*Interpretação dos resultados
*Comparação com fontes externas (e.g., WHO, dados governamentais)
*Limitações dos dados e da análise

# Conclusão

*Principais conclusões sobre o impacto da poluição do ar
*Sugestões para futuras investigações

# Referências



# Anexos


